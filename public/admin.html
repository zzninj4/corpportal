<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å - –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π –ø–æ—Ä—Ç–∞–ª</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/admin_style.css">
</head>
<body>
    <header>
        <div class="header-content">
            <img src="/public/icons/logo.png" class="logo-png45" alt="Logo">
            <div class="header-text">
                <h2>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h2>
                <h1>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
                <p>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</p>
            </div>
            <div class="user-menu" id="userMenu">
                <div class="user-avatar" id="userAvatar"></div>
                <div class="user-name" id="userName"></div>
                <a href="#" class="logout-button" onclick="logout(event)">–í—ã–π—Ç–∏</a>
            </div>
        </div>
    </header>
    <nav>
        <ul id="navList">
            <li><a href="/indexmain.html"><img src="/public/icons/home2.png" alt="Home Icon" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px;">–ì–ª–∞–≤–Ω–∞—è</a></li>
            <li><a href="/files.html"><img src="/public/icons/doc.png" alt="Files Icon" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px;">–§–∞–π–ª–æ–≤—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä</a></li>
            <li><a href="/chat.html"><img src="/public/icons/chat.png" alt="Chat Icon" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px;">–ß–∞—Ç</a></li>
            <li><a href="/admin.html"><img src="/public/icons/admin.png" alt="Admin Icon" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px;">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a></li>
        </ul>
    </nav>
    <div class="container">
        <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h1>
        <div class="add-user card">
            <h2>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
            <p class="error" id="registerError"></p>
            <form id="registerForm">
                <div class="form-group">
                    <label for="name">–ò–º—è</label>
                    <input type="text" id="name" name="name" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
                </div>
                <div class="form-group">
                    <label for="surname">–§–∞–º–∏–ª–∏—è</label>
                    <input type="text" id="surname" name="surname" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é">
                </div>
                <div class="form-group">
                    <label for="username">–õ–æ–≥–∏–Ω</label>
                    <input type="text" id="username" name="username" required placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω">
                </div>
                <div class="form-group">
                    <label for="password">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="password" name="password" required placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
                <div class="form-group">
                    <label for="number">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                    <input type="text" id="number" name="number" required placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞">
                </div>
                <button type="submit" class="btn"><img src="/public/icons/add-user.png" alt="Add User Icon">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
            </form>
        </div>
        <div class="edit-user card">
            <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
            <p class="error" id="editError"></p>
            <form id="editUserForm">
                <div class="form-group">
                    <label for="editUserSelect">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</label>
                    <select id="editUserSelect" name="userId" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editName">–ò–º—è</label>
                    <input type="text" id="editName" name="name" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
                </div>
                <div class="form-group">
                    <label for="editSurname">–§–∞–º–∏–ª–∏—è</label>
                    <input type="text" id="editSurname" name="surname" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é">
                </div>
                <div class="form-group">
                    <label for="editUsername">–õ–æ–≥–∏–Ω</label>
                    <input type="text" id="editUsername" name="username" required placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω">
                </div>
                <div class="form-group">
                    <label for="editPassword">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="editPassword" name="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
                </div>
                <div class="form-group">
                    <label for="editNumber">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                    <input type="text" id="editNumber" name="number" required placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞">
                </div>
                <button type="submit" class="btn"><img src="/public/icons/save.png" alt="Save Icon">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            </form>
        </div>
        <div class="user-list card">
            <h2>–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>
            <table class="user-table">
                <thead>
                    <tr>
                        <th>–ò–º—è/–§–∞–º–∏–ª–∏—è</th>
                        <th>–õ–æ–≥–∏–Ω</th>
                        <th>–ü–∞—Ä–æ–ª—å</th>
                        <th>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="userTableBody"></tbody>
            </table>
        </div>
    </div>
    <div id="userMenuModal" class="modal">
        <button class="delete" onclick="deleteUserFromModal()">–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>
        <button onclick="featureInDevelopment()">–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</button>
    </div>
    <footer>
        <p>¬© 2025 –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π –ø–æ—Ä—Ç–∞–ª —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
        <p>–î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à—ë–Ω —Ç–æ–ª—å–∫–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏.</p>
    </footer>
    <script>
        // –ü–µ—Ä–µ—Ö–≤–∞—Ç fetch –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
        const originalFetch = window.fetch;
        window.fetch = async (url, options = {}) => {
            const token = localStorage.getItem('token');
            const headers = { ...options.headers, ...(token && { Authorization: `Bearer ${token}` }) };
            return originalFetch(url, { ...options, headers });
        };

        window.onload = async () => {
            const token = localStorage.getItem('token');
            if (!token) {
                console.error('–¢–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ login.html');
                setTimeout(() => window.location.href = '/login.html', 1000);
                return;
            }
            try {
                await Promise.all([displayUserInfo(), checkAdminAccess()]);
                loadUsers();
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ userMenu
                document.getElementById('userMenu').addEventListener('click', (event) => {
                    if (event.target.classList.contains('logout-button')) return; // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ "–í—ã–π—Ç–∏"
                    window.location.href = './profile.html';
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã:', error);
                setTimeout(() => window.location.href = '/login.html', 1000);
            }
        };

        async function displayUserInfo() {
            const token = localStorage.getItem('token');
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            if (!token) {
                console.error('–¢–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ displayUserInfo');
                throw new Error('–¢–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç');
            }
            try {
                const response = await fetch('/api/user');
                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`–û—à–∏–±–∫–∞ /api/user: HTTP ${response.status}: ${text}`);
                }
                const data = await response.json();
                userAvatar.textContent = data.username.split(' ').map(word => word[0]).join('').slice(0, 2);
                userName.textContent = data.username;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤ displayUserInfo:', error.message);
                localStorage.removeItem('token');
                throw error;
            }
        }

        async function checkAdminAccess() {
            const token = localStorage.getItem('token');
            if (!token) {
                console.error('–¢–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ checkAdminAccess');
                throw new Error('–¢–æ–∫–µ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç');
            }
            try {
                const response = await fetch('/api/check-admin');
                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`–û—à–∏–±–∫–∞ /api/check-admin: HTTP ${response.status}: ${text}`);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤ checkAdminAccess:', error.message);
                throw error;
            }
        }

        function logout(event) {
            event.stopPropagation(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
            localStorage.removeItem('token');
            window.location.href = '/login.html';
        }

        let currentUserId = null;
        const passwordCache = {};

        function openUserMenu(userId, event) {
            currentUserId = userId;
            const modal = document.getElementById('userMenuModal');
            const rect = event.target.getBoundingClientRect();
            modal.style.top = `${rect.bottom + window.scrollY}px`;
            modal.style.left = `${rect.left + window.scrollX}px`;
            modal.style.display = 'block';
            document.addEventListener('click', closeUserMenuOnClickOutside);
        }

        function closeUserMenu() {
            const modal = document.getElementById('userMenuModal');
            modal.style.display = 'none';
            document.removeEventListener('click', closeUserMenuOnClickOutside);
            currentUserId = null;
        }

        function closeUserMenuOnClickOutside(event) {
            const modal = document.getElementById('userMenuModal');
            if (!modal.contains(event.target) && !event.target.classList.contains('menu-icon')) {
                closeUserMenu();
            }
        }

        function deleteUserFromModal() {
            if (currentUserId) {
                deleteUser(currentUserId);
                closeUserMenu();
            }
        }

        function featureInDevelopment() {
            alert('–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
            closeUserMenu();
        }

        async function togglePassword(userId, element) {
            const passwordText = element.previousElementSibling;
            if (passwordText.textContent !== '****') {
                passwordText.textContent = '****';
                return;
            }
            if (!passwordCache[userId]) {
                try {
                    const response = await fetch(`/api/user/${userId}`);
                    if (!response.ok) {
                        const text = await response.text();
                        throw new Error(`HTTP ${response.status}: ${text}`);
                    }
                    const user = await response.json();
                    // –í–†–ï–ú–ï–ù–ù–û: –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç password –≤ plaintext
                    // –í —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –ø–∞—Ä–æ–ª—å —Ö–µ—à–∏—Ä–æ–≤–∞–Ω, –Ω—É–∂–µ–Ω –¥—Ä—É–≥–æ–π –ø–æ–¥—Ö–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω)
                    passwordCache[userId] = user.password || 'N/A';
                } catch (error) {
                    console.error('Error fetching password:', error);
                    document.getElementById('editError').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞—Ä–æ–ª—è: ' + error.message;
                    document.getElementById('editError').style.display = 'block';
                    return;
                }
            }
            passwordText.textContent = passwordCache[userId];
        }

        function loadUsers() {
            fetch('/api/users')
                .then(async (response) => {
                    if (!response.ok) {
                        const text = await response.text();
                        throw new Error(`HTTP ${response.status}: ${text}`);
                    }
                    return response.json();
                })
                .then((users) => {
                    const userTableBody = document.getElementById('userTableBody');
                    const editUserSelect = document.getElementById('editUserSelect');
                    userTableBody.innerHTML = '';
                    editUserSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</option>';

                    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∏—Å–∫–ª—é—á–∞—è admin
                    const nonAdminUsers = users.filter(user => user.username !== 'admin');

                    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É
                    if (nonAdminUsers.length === 0) {
                        userTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>';
                    } else {
                        nonAdminUsers.forEach((user) => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${user.name || '–±–µ–∑—ã–º—è–Ω–Ω—ã–π'} ${user.surname || ''}</td>
                                <td>${user.username}</td>
                                <td><span class="password-text" data-user-id="${user.id}">****</span><span class="eye-icon" onclick="togglePassword('${user.id}', this)">üëÅÔ∏è</span></td>
                                <td>${user.number}</td>
                                <td><span class="menu-icon" onclick="openUserMenu('${user.id}', event)">‚ãÆ</span></td>
                            `;
                            userTableBody.appendChild(row);
                        });
                    }

                    // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫, –∏—Å–∫–ª—é—á–∞—è admin
                    nonAdminUsers.forEach((user) => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é, —É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
                        const displayName = `${user.name || ''} ${user.surname || ''}`.trim() || user.username;
                        option.textContent = displayName;
                        editUserSelect.appendChild(option);
                    });
                })
                .catch((error) => {
                    console.error('Error loading users:', error);
                    const errorMessage = error.message.includes('401') ? '–¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.' :
                                  error.message.includes('403') ? '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω: —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.' :
                                  '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ' + error.message;
                    document.getElementById('editError').textContent = errorMessage;
                    document.getElementById('editError').style.display = 'block';
                    if (error.message.includes('401')) {
                        localStorage.removeItem('token');
                        setTimeout(() => window.location.href = '/login.html', 1000);
                    }
                });
        }

        document.getElementById('editUserSelect').addEventListener('change', async (e) => {
            const userId = e.target.value;
            const editError = document.getElementById('editError');
            if (!userId) {
                document.getElementById('editName').value = '';
                document.getElementById('editSurname').value = '';
                document.getElementById('editUsername').value = '';
                document.getElementById('editPassword').value = '';
                document.getElementById('editNumber').value = '';
                return;
            }
            try {
                const response = await fetch(`/api/user/${userId}`);
                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`HTTP ${response.status}: ${text}`);
                }
                const user = await response.json();
                document.getElementById('editName').value = user.name || '';
                document.getElementById('editSurname').value = user.surname || '';
                document.getElementById('editUsername').value = user.username;
                document.getElementById('editPassword').value = '';
                document.getElementById('editNumber').value = user.number;
                editError.style.display = 'none';
            } catch (error) {
                console.error('Error fetching user:', error);
                const errorMessage = error.message.includes('401') ? '–¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.' :
                              error.message.includes('404') ? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.' :
                              '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + error.message;
                editError.textContent = errorMessage;
                editError.style.display = 'block';
                if (error.message.includes('401')) {
                    localStorage.removeItem('token');
                    setTimeout(() => window.location.href = '/login.html', 1000);
                }
            }
        });

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('name').value;
            const surname = document.getElementById('surname').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const number = document.getElementById('number').value;
            const errorMessage = document.getElementById('registerError');
            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, surname, username, password, number })
                });
                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`HTTP ${response.status}: ${text}`);
                }
                const data = await response.json();
                if (data.success) {
                    alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!');
                    document.getElementById('registerForm').reset();
                    loadUsers();
                    errorMessage.style.display = 'none';
                } else {
                    errorMessage.textContent = data.error || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏';
                    errorMessage.style.display = 'block';
                }
            } catch (error) {
                console.error('Registration error:', error);
                const errorMessageText = error.message.includes('401') ? '–¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.' :
                                 error.message.includes('403') ? '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω: —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.' :
                                 '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + error.message;
                errorMessage.textContent = errorMessageText;
                errorMessage.style.display = 'block';
                if (error.message.includes('401')) {
                    localStorage.removeItem('token');
                    setTimeout(() => window.location.href = '/login.html', 1000);
                }
            }
        });

        document.getElementById('editUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const userId = document.getElementById('editUserSelect').value;
            const name = document.getElementById('editName').value;
            const surname = document.getElementById('editSurname').value;
            const username = document.getElementById('editUsername').value;
            const password = document.getElementById('editPassword').value;
            const number = document.getElementById('editNumber').value;
            const errorMessage = document.getElementById('editError');
            if (!userId) {
                errorMessage.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è';
                errorMessage.style.display = 'block';
                return;
            }
            try {
                const response = await fetch(`/api/user/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, surname, username, password, number })
                });
                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`HTTP ${response.status}: ${text}`);
                }
                const data = await response.json();
                if (data.success) {
                    alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω!');
                    document.getElementById('editUserForm').reset();
                    document.getElementById('editUserSelect').value = '';
                    loadUsers();
                    errorMessage.style.display = 'none';
                } else {
                    errorMessage.textContent = data.error || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è';
                    errorMessage.style.display = 'block';
                }
            } catch (error) {
                console.error('Update error:', error);
                const errorMessageText = error.message.includes('401') ? '–¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.' :
                                 error.message.includes('403') ? '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω: —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.' :
                                 error.message.includes('404') ? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.' :
                                 '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: ' + error.message;
                errorMessage.textContent = errorMessageText;
                errorMessage.style.display = 'block';
                if (error.message.includes('401')) {
                    localStorage.removeItem('token');
                    setTimeout(() => window.location.href = '/login.html', 1000);
                }
            }
        });

        async function deleteUser(userId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;
            const errorMessage = document.getElementById('editError');
            try {
                const response = await fetch(`/api/user/${userId}`, {
                    method: 'DELETE'
                });
                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`HTTP ${response.status}: ${text}`);
                }
                const data = await response.json();
                if (data.success) {
                    alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω!');
                    loadUsers();
                    errorMessage.style.display = 'none';
                } else {
                    errorMessage.textContent = data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è';
                    errorMessage.style.display = 'block';
                }
            } catch (error) {
                console.error('Delete error:', error);
                const errorMessageText = error.message.includes('401') ? '–¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.' :
                                 error.message.includes('403') ? '–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å: –∑–∞—â–∏—â—ë–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤.' :
                                 error.message.includes('404') ? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.' :
                                 '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message;
                errorMessage.textContent = errorMessageText;
                errorMessage.style.display = 'block';
                if (error.message.includes('401')) {
                    localStorage.removeItem('token');
                    setTimeout(() => window.location.href = '/login.html', 1000);
                }
            }
        }
    </script>
</body>
</html>